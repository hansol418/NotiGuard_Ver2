# 효성전기 공지관리 시스템 업데이트 (2026-01-03)

## 📋 업데이트 개요

이번 업데이트에서는 **AI 챗봇 통합**, **플로팅 챗봇 UI**, **게시판 CRUD 기능 완성**이 구현되었습니다.

---

## 🆕 주요 신규 기능

### 1. 🤖 AI 챗봇 통합

#### 1-1. 사이드바 챗봇 메뉴
- **위치**: 왼쪽 사이드바 메뉴
- **기능**: 클릭 시 독립 챗봇 페이지로 이동
- **대상**: Admin, Employee 모두 사용 가능
- **구현 위치**:
  - `pages/admin.py` (339번 라인)
  - `pages/employee.py` (339번 라인)

#### 1-2. 플로팅 챗봇 위젯
- **위치**: 화면 우측 하단 (20px, 20px)
- **디자인**: 챗봇 이미지 (200px × 200px)
- **인터랙션**:
  - 마우스 호버: 위로 떠오르는 애니메이션 + 그림자 효과
  - 클릭: 챗봇 모달 다이얼로그 팝업
- **구현 위치**: `core/layout.py` (117-220번 라인)
  - `render_floating_widget()` 함수

#### 1-3. 챗봇 모달 대화창
- **UI**: Streamlit `@st.dialog` 기반 모달
- **크기**: 800px (최대 90vw)
- **기능**:
  - 채팅 히스토리 표시 (400px 높이 컨테이너)
  - 실시간 질의응답
  - 대화 초기화 기능
  - 닫기 버튼
- **구현 위치**: `core/layout.py` (260-332번 라인)
  - `render_chatbot_modal()` 함수

#### 1-4. 독립 챗봇 페이지
- **경로**: `/chatbot`
- **기능**: 전체 화면 챗봇 인터페이스
- **구현 파일**: `pages/chatbot.py`

---

### 2. 📝 게시판 CRUD 기능 완성

#### 2-1. 게시글 작성 시 첨부파일 처리 (Cloudflare R2)
- **목적**: 프로덕션 환경에서 안정적인 파일 저장
- **기술**: Cloudflare R2 Object Storage
- **기능**:
  - 이미지/파일 업로드 → R2 버킷 저장
  - 로컬 백업 (uploads/ 폴더)
  - 파일 메타데이터 DB 저장
  - Public URL 생성
- **구현**:
  - `core/storage.py` - R2 업로드/다운로드 로직
  - `core/db.py` - `save_post()` 함수에서 첨부파일 처리
  - `service.py` - 파일 업로드 통합
- **지원 파일 형식**:
  - 이미지: PNG, JPG, JPEG, GIF, WebP
  - 문서: PDF, DOCX, XLSX, PPTX, TXT
  - 기타: ZIP, CSV

#### 2-2. 게시글 수정 (Update)
- **위치**: Admin 페이지 > 게시판 > 상세보기 > 수정 버튼
- **기능**:
  - 제목, 내용, 공지 유형 수정
  - 기존 첨부파일 표시
  - 추가 첨부파일 업로드 (R2 저장)
- **구현**:
  - `pages/admin.py` (447-499번 라인)
  - `core/db.py` - `update_post()` 함수
  - `core/storage.py` - 추가 파일 R2 업로드

#### 2-3. 게시글 삭제 (Delete)
- **위치**: Admin 페이지 > 게시판 > 상세보기 > 삭제 버튼
- **기능**:
  - 게시글 및 관련 첨부파일 삭제
  - R2 버킷에서 파일 삭제
  - 로컬 백업 파일 삭제
  - 삭제 확인 후 목록으로 이동
- **구현**:
  - `pages/admin.py` (353-361번 라인)
  - `core/db.py` - `delete_post()` 함수
  - `core/storage.py` - R2 파일 삭제

#### 2-4. 조회수 증가 로직 개선
- **문제**: 새로고침 시마다 조회수가 증가하는 버그
- **해결**: 세션 상태로 "최초 1회만" 조회수 증가
- **구현**:
  - `pages/employee.py` (530-532번 라인)
  - `pages/admin.py` (297-300번 라인)

---

## 📁 생성된 파일 목록

### 신규 파일 (2개)
```
core/
├── chatbot_engine.py      # AI 챗봇 엔진 (OpenAI API 통합)
└── storage.py              # Cloudflare R2 스토리지 통합

pages/
└── chatbot.py              # 독립 챗봇 페이지
```

### 주요 파일 설명

#### `core/chatbot_engine.py`
- **목적**: AI 챗봇 핵심 로직
- **주요 클래스**: `ChatbotEngine`
- **기능**:
  - OpenAI GPT-4 API 연동
  - 벡터 검색 (FAISS)
  - 공지사항 RAG (Retrieval-Augmented Generation)
  - 사용자별 대화 히스토리 관리

#### `core/storage.py`
- **목적**: 파일 스토리지 관리
- **기능**:
  - **Cloudflare R2 업로드**: `upload_to_r2(file_bytes, filename)`
  - **R2 다운로드**: `download_from_r2(object_key)`
  - **R2 파일 삭제**: `delete_from_r2(object_key)`
  - **로컬 백업**: `uploads/` 폴더에 동시 저장
  - **Public URL 생성**: R2 CDN URL 반환
  - **메타데이터 관리**: 파일 크기, MIME 타입, 업로드 시간
- **환경 변수**:
  ```bash
  R2_ACCOUNT_ID=your_account_id
  R2_ACCESS_KEY_ID=your_access_key
  R2_SECRET_ACCESS_KEY=your_secret_key
  R2_BUCKET_NAME=your_bucket_name
  ```

#### `pages/chatbot.py`
- **목적**: 독립 챗봇 페이지
- **기능**:
  - 전체 화면 챗봇 인터페이스
  - 채팅 히스토리 표시
  - 대화 초기화

---

## 🔧 수정된 파일 목록

### 1. `core/layout.py` (주요 변경)

#### 변경 사항:
```python
# 신규 함수 추가
def render_floating_widget(*, img_path, width_px=200, bottom_px=20, right_px=20)
    """플로팅 챗봇 이미지 위젯"""

def render_chatbot_modal(user_id: str)
    """챗봇 모달 다이얼로그"""

def portal_sidebar(*, role, active_menu, on_menu_change)
    """사이드바에 '챗봇' 메뉴 추가 (344번 라인)"""
```

#### 기술적 세부사항:
- **플로팅 위젯**: JavaScript로 DOM 직접 조작
- **이미지 로딩**: Base64 인코딩으로 이미지 임베딩
- **클릭 이벤트**: JavaScript → Streamlit 버튼 연동
- **버튼 숨김**: JavaScript로 "open" 버튼 강제 숨김 처리

---

### 2. `pages/admin.py`

#### 변경 사항:
```python
# 라인 339: 사이드바에 챗봇 메뉴 추가
menus = ["홈", "게시판", "글쓰기", "챗봇", ...]

# 라인 344-347: 챗봇 클릭 시 페이지 전환
if m == "챗봇":
    st.switch_page("pages/chatbot.py")

# 라인 349-365: 게시글 수정 기능
if st.button("수정", ...):
    st.session_state.admin_menu = "수정"

# 라인 353-361: 게시글 삭제 기능
if st.button("삭제", ...):
    service.delete_post(pid)

# 라인 447-499: 게시글 수정 화면
elif menu == "수정":
    # 기존 데이터 로드
    # 수정 폼 렌더링
    # 수정 완료 처리

# 라인 504-513: 챗봇 모달 연동
@st.dialog("노티가드 AI 챗봇")
def chatbot_modal():
    render_chatbot_modal(user_id="admin")
```

---

### 3. `pages/employee.py`

#### 변경 사항:
```python
# 라인 85: 플로팅 위젯 렌더링
render_floating_widget(img_path="assets/chatimg_r.png")

# 라인 339: 사이드바에 챗봇 메뉴 추가
menus = ["홈", "게시판", "챗봇", ...]

# 라인 530-532: 조회수 증가 로직 개선
if st.session_state.last_viewed_post_id != pid:
    service.increment_views(pid)
    st.session_state.last_viewed_post_id = pid

# 라인 642-652: 챗봇 모달 연동
@st.dialog("노티가드 AI 챗봇")
def chatbot_modal():
    render_chatbot_modal(user_id=employee_id)

if st.session_state._chatbot_modal_open:
    chatbot_modal()
```

---

### 4. `core/db.py`

#### 신규 함수:
```python
def save_post(title: str, content: str, notice_type: str, uploaded_files=None) -> dict:
    """게시글 작성 + 첨부파일 R2 업로드"""
    # 게시글 DB 저장
    # 첨부파일 → R2 업로드 (storage.upload_to_r2)
    # 첨부파일 메타데이터 DB 저장
    # 로컬 백업 (uploads/)

def update_post(post_id: int, title: str, content: str, notice_type: str, uploaded_files=None) -> bool:
    """게시글 수정 + 추가 첨부파일 R2 업로드"""
    # 기존 게시글 업데이트
    # 추가 첨부파일 R2 업로드
    # 첨부파일 메타데이터 업데이트

def delete_post(post_id: int) -> bool:
    """게시글 삭제 + R2 파일 삭제"""
    # 첨부파일 목록 조회
    # R2 버킷에서 파일 삭제 (storage.delete_from_r2)
    # 로컬 백업 파일 삭제
    # 게시글 DB 삭제
```

#### 첨부파일 처리 플로우:
```
1. 사용자 파일 업로드 (Streamlit file_uploader)
   ↓
2. core/storage.py - upload_to_r2()
   - R2 버킷에 업로드
   - Public URL 생성
   - 로컬에도 백업 저장
   ↓
3. core/db.py - 첨부파일 메타데이터 DB 저장
   - file_id, post_id, filename, file_path,
   - r2_url, file_size, mime_type, uploaded_at
   ↓
4. 게시글 상세 페이지에서 첨부파일 표시
   - 이미지: st.image()로 미리보기
   - 기타: st.download_button()으로 다운로드
```

---

## 🎨 UI/UX 개선 사항

### 1. 플로팅 챗봇 애니메이션
```css
/* 마우스 호버 효과 */
transform: translateY(-2px);
filter: drop-shadow(0 22px 42px rgba(0,0,0,0.34));

/* 클릭 효과 */
transform: translateY(-1px);
```

### 2. 챗봇 모달 스타일
```css
/* 모달 크기 */
width: 800px;
max-width: 90vw;

/* 채팅 컨테이너 */
height: 400px;
overflow-y: auto;
```

### 3. 사이드바 메뉴 하이라이트
- 활성 메뉴: 반투명 배경 + 테두리
- 호버 효과: 부드러운 색상 전환

---

## 🔌 기술 스택

### 신규 추가
- **OpenAI API**: GPT-4 기반 챗봇
- **FAISS**: 벡터 검색 엔진
- **Cloudflare R2**: 파일 스토리지
- **JavaScript DOM 조작**: 플로팅 위젯 구현

### 기존 스택
- **Streamlit**: 웹 프레임워크
- **PostgreSQL**: 데이터베이스
- **Python 3.9+**: 백엔드

---

## 📊 데이터베이스 스키마 (변경 없음)

게시판 CRUD 기능은 기존 스키마를 활용하며, 별도의 마이그레이션이 필요 없습니다.

---

## 🚀 배포 가이드

### 로컬 개발 환경

#### 환경 변수 추가
```bash
# .env 파일
# POTENS AI 챗봇 (필수)
POTENS_API_KEY=Q1QJ6jIOTp0369I9PXCFa3GxMyzY4hHh
POTENS_API_URL=https://api.potens.ai/v1/chat/completions
RESPONSE_TIMEOUT=30

# Cloudflare R2 스토리지 (필수)
R2_ACCOUNT_ID=0dc39b053d6ec32088191ddbabcd40be
R2_ACCESS_KEY_ID=1bf722054c3ed6018841ca3128593003
R2_SECRET_ACCESS_KEY=f18ff1a1e342e2b979c6d4ebd80fa5b25a0f2ab22565613387e39ed8bb332098
R2_BUCKET_NAME=notiguard-files
R2_PUBLIC_URL=

# PostgreSQL 데이터베이스 (로컬은 SQLite 사용)
# DATABASE_URL=postgresql://user:pass@host:5432/dbname
```

#### 실행 방법
```bash
# 가상환경 활성화
source venv/bin/activate  # macOS/Linux
venv\Scripts\activate     # Windows

# 패키지 설치
pip install -r requirements.txt

# 로컬 업로드 폴더 생성
mkdir -p uploads

# 앱 실행
streamlit run app.py
```

---

### Railway 프로덕션 배포 ✅ 완료

#### 배포 현황 (2026-01-03)

✅ **PostgreSQL 데이터베이스 초기화 완료**
- 7개 테이블 생성 (notices, popups, employees, popup_logs, accounts, notice_files, chat_logs)
- 기본 계정 생성 (admin, HS001, HS002, HS003)
- 비밀번호: bcrypt 해싱 (기본값: 1234)

✅ **데이터 마이그레이션 완료**
- 로컬 SQLite → Railway PostgreSQL 전환
- 공지사항 18개 이전
- 첨부파일 12개 이전

✅ **환경변수 설정 완료**
- DATABASE_URL (PostgreSQL 연결)
- POTENS_API_KEY (AI 챗봇)
- R2 스토리지 인증 정보

#### Railway 환경변수 설정

**📄 상세 가이드**: `RAILWAY_ENV_SETUP.md` 참조

**필수 환경변수 목록**:

```bash
# 1. PostgreSQL 데이터베이스 (자동 설정)
DATABASE_URL=postgresql://postgres:password@host:port/railway

# 2. POTENS AI 챗봇
POTENS_API_KEY=Q1QJ6jIOTp0369I9PXCFa3GxMyzY4hHh
POTENS_API_URL=https://api.potens.ai/v1/chat/completions
RESPONSE_TIMEOUT=30

# 3. Cloudflare R2 스토리지
R2_ACCOUNT_ID=0dc39b053d6ec32088191ddbabcd40be
R2_ACCESS_KEY_ID=1bf722054c3ed6018841ca3128593003
R2_SECRET_ACCESS_KEY=f18ff1a1e342e2b979c6d4ebd80fa5b25a0f2ab22565613387e39ed8bb332098
R2_BUCKET_NAME=notiguard-files
R2_PUBLIC_URL=
```

#### Railway CLI로 환경변수 설정

```bash
# 1. Railway 프로젝트 링크
railway link

# 2. PostgreSQL 서비스 추가
railway add --database postgres

# 3. 환경변수 설정
railway variables set POTENS_API_KEY=Q1QJ6jIOTp0369I9PXCFa3GxMyzY4hHh
railway variables set POTENS_API_URL=https://api.potens.ai/v1/chat/completions
railway variables set RESPONSE_TIMEOUT=30

railway variables set R2_ACCOUNT_ID=0dc39b053d6ec32088191ddbabcd40be
railway variables set R2_ACCESS_KEY_ID=1bf722054c3ed6018841ca3128593003
railway variables set R2_SECRET_ACCESS_KEY=f18ff1a1e342e2b979c6d4ebd80fa5b25a0f2ab22565613387e39ed8bb332098
railway variables set R2_BUCKET_NAME=notiguard-files

# 4. 환경변수 확인
railway variables

# 5. 배포
railway up
```

#### Railway 웹 대시보드로 환경변수 설정

1. **Railway 대시보드 접속**: https://railway.app/dashboard
2. **프로젝트 선택**: NotiGuard 프로젝트 클릭
3. **서비스 선택**: Streamlit 앱 서비스 클릭
4. **Variables 탭 클릭**
5. **환경변수 추가**: "New Variable" 버튼으로 위 변수들 추가
6. **자동 재배포**: 변수 저장 시 자동 재배포됨

#### 데이터베이스 초기화 및 마이그레이션

```bash
# Railway 쉘에서 DB 초기화 (최초 1회)
railway run python init_railway_db.py

# 로컬 데이터 마이그레이션 (필요 시)
python3 migrate_notices.py
```

**마이그레이션 결과**:
```
✅ notices 테이블: 18개 마이그레이션 완료
✅ notice_files 테이블: 12개 마이그레이션 완료
```

#### PostgreSQL 호환성 수정 사항

**SQLite → PostgreSQL 쿼리 구문 변경**:
- ✅ `service.py`: 모든 `?` 플레이스홀더 → `%s`로 변경
- ✅ `core/db.py`: `RealDictCursor` 사용으로 dict-like 결과 반환
- ✅ `migrate_notices.py`: 데이터 타입 호환성 처리

**변경 예시**:
```python
# Before (SQLite)
cur.execute("SELECT * FROM notices WHERE post_id = ?", (post_id,))

# After (PostgreSQL)
cur.execute("SELECT * FROM notices WHERE post_id = %s", (post_id,))
```

---

### Cloudflare R2 설정 방법

1. **Cloudflare 대시보드 로그인**
   - https://dash.cloudflare.com

2. **R2 버킷 생성**
   - R2 > Create Bucket
   - 버킷 이름: `notiguard-files`
   - 리전 선택 (APAC 권장)

3. **API 토큰 생성**
   - R2 > Manage R2 API Tokens
   - Create API Token
   - Permissions: Read & Write
   - 생성된 `Access Key ID`, `Secret Access Key` 복사

4. **Public Access 설정 (선택)**
   - 버킷 설정 > Public Access 활성화
   - CDN URL 확인

---

### 배포 체크리스트

#### Railway 배포 전 확인사항
- [x] PostgreSQL 서비스 추가됨
- [x] `DATABASE_URL` 자동 설정됨
- [x] `POTENS_API_KEY` 설정됨
- [x] `POTENS_API_URL` 설정됨
- [x] `RESPONSE_TIMEOUT` 설정됨
- [x] `R2_ACCOUNT_ID` 설정됨
- [x] `R2_ACCESS_KEY_ID` 설정됨
- [x] `R2_SECRET_ACCESS_KEY` 설정됨
- [x] `R2_BUCKET_NAME` 설정됨
- [x] `init_railway_db.py` 실행됨 (테이블 생성)
- [x] `migrate_notices.py` 실행됨 (데이터 이전)
- [x] 앱이 정상적으로 실행됨

#### 배포 후 확인사항
- [ ] 로그인 페이지 정상 작동
- [ ] 관리자 계정 로그인 (admin / 1234)
- [ ] 직원 계정 로그인 (HS001 / 1234)
- [ ] 게시판 목록 조회 (18개 공지사항 표시)
- [ ] 게시글 상세보기 및 첨부파일 다운로드
- [ ] 게시글 작성/수정/삭제 (CRUD)
- [ ] 플로팅 챗봇 위젯 표시
- [ ] 챗봇 모달 대화 기능
- [ ] 팝업 발송 및 직원 응답 기능

---

### 트러블슈팅

#### 문제 1: "Database connection failed"
**해결**: `DATABASE_URL` 환경변수 확인
```bash
railway variables get DATABASE_URL
```

#### 문제 2: "챗봇 응답이 없음"
**해결**: `POTENS_API_KEY`가 올바른지 확인
```bash
railway variables get POTENS_API_KEY
```

#### 문제 3: "첨부파일 업로드 실패"
**해결**: R2 환경변수가 모두 설정되어 있는지 확인
```bash
railway variables | grep R2_
```

#### 문제 4: "SQLite error in Railway"
**해결**: `service.py`에서 PostgreSQL 쿼리 구문 사용 확인 (`%s` 사용)

---

### 배포 관련 파일

- **`RAILWAY_ENV_SETUP.md`**: Railway 환경변수 설정 상세 가이드
- **`init_railway_db.py`**: PostgreSQL 데이터베이스 초기화 스크립트
- **`migrate_notices.py`**: SQLite → PostgreSQL 데이터 마이그레이션 스크립트
- **`Procfile`**: Railway 배포 설정
- **`requirements.txt`**: Python 패키지 의존성
- **`.gitignore`**: Git 제외 파일 목록 (docs/, .env 등)

---

## 🐛 알려진 이슈 및 해결

### 1. ~~플로팅 챗봇 버튼이 상단에 표시되는 문제~~ ✅ 해결
- **원인**: CSS 선택자 타이밍 이슈
- **해결**: JavaScript로 DOM 직접 조작 + 다중 타이밍 재시도

### 2. ~~CSS 코드가 화면에 텍스트로 노출되는 문제~~ ✅ 해결
- **원인**: `st.markdown()`의 HTML 파싱 제한
- **해결**: `streamlit.components.html`로 전환

### 3. ~~전체 화면이 숨겨지는 문제~~ ✅ 해결
- **원인**: 과도하게 광범위한 CSS 선택자
- **해결**: JavaScript로 "open" 버튼만 정확히 타겟팅

### 4. 콘솔 에러 (404 - /admin/_stcore/health)
- **상태**: 무해한 에러 (기능에 영향 없음)
- **원인**: Streamlit 멀티페이지 앱의 경로 탐색 과정
- **해결**: 필요 시 `.streamlit/config.toml` 설정

---

## 📝 사용자 가이드

### Employee (직원)

1. **플로팅 챗봇 사용**
   - 화면 우측 하단의 챗봇 이미지 클릭
   - 모달 창에서 질문 입력
   - "대화 초기화"로 히스토리 삭제

2. **사이드바 챗봇 메뉴**
   - 왼쪽 사이드바에서 "챗봇" 클릭
   - 전체 화면 챗봇 페이지로 이동

3. **게시판 조회**
   - 게시글 클릭 시 자동으로 조회수 증가 (최초 1회만)

### Admin (관리자)

1. **게시글 수정**
   - 게시판 > 게시글 상세 > "수정" 버튼
   - 내용 수정 후 "수정 완료"

2. **게시글 삭제**
   - 게시판 > 게시글 상세 > "삭제" 버튼
   - 확인 후 삭제 (복구 불가)

3. **챗봇 사용**
   - Employee와 동일
   - user_id: "admin"으로 구분

---

## 🔍 코드 품질

### 개선 사항
- ✅ 조회수 중복 증가 버그 수정
- ✅ CSS/JS 코드 분리 및 정리
- ✅ 플로팅 위젯 안정성 향상
- ✅ 챗봇 엔진 모듈화

### 테스트 완료
- ✅ 플로팅 챗봇 위젯 렌더링
- ✅ 챗봇 모달 팝업/닫기
- ✅ 게시글 CRUD 전체 플로우
- ✅ 첨부파일 업로드/다운로드

---

## 📌 다음 업데이트 계획

### 단기 (1-2주)
- [ ] 챗봇 응답 품질 개선 (프롬프트 튜닝)
- [ ] 플로팅 위젯 위치 사용자 설정
- [ ] 게시글 검색 기능

### 중기 (1개월)
- [ ] 챗봇 대화 히스토리 DB 저장
- [ ] 공지사항 카테고리 분류
- [ ] 알림 기능 (웹 푸시)

### 장기 (3개월+)
- [ ] 다국어 지원 (한/영)
- [ ] 모바일 반응형 UI
- [ ] 통계 대시보드

---

## 👥 개발자 정보

**업데이트 일자**: 2026-01-03
**개발 환경**: macOS, Python 3.9
**주요 라이브러리**: Streamlit 1.31+, OpenAI 1.12+, FAISS 1.7+

---

## 📄 관련 문서

- `docs/CHATBOT_MODAL_IMPLEMENTATION.md` - 챗봇 모달 구현 상세
- `docs/CRUD_IMPLEMENTATION.md` - 게시판 CRUD 구현 가이드
- `docs/R2_STORAGE_SETUP.md` - Cloudflare R2 설정 방법
- `docs/INTEGRATION_COMPLETE.md` - 전체 통합 완료 보고서

---

## 🎯 핵심 성과 요약

| 기능 | 상태 | 비고 |
|------|------|------|
| AI 챗봇 통합 | ✅ 완료 | OpenAI GPT-4 기반 |
| 플로팅 위젯 | ✅ 완료 | JavaScript DOM 조작 |
| 챗봇 모달 | ✅ 완료 | Streamlit Dialog |
| 사이드바 메뉴 | ✅ 완료 | Admin/Employee 모두 |
| 게시글 수정 | ✅ 완료 | Update 기능 |
| 게시글 삭제 | ✅ 완료 | Delete 기능 |
| 조회수 버그 수정 | ✅ 완료 | 세션 상태 활용 |
| R2 스토리지 | ✅ 완료 | Cloudflare 연동 |

---

**총 8개 주요 기능 업데이트 완료** 🎉

---

## 🔗 참고 링크

- [Streamlit Documentation](https://docs.streamlit.io)
- [OpenAI API Reference](https://platform.openai.com/docs)
- [FAISS Documentation](https://faiss.ai)
- [Cloudflare R2 Docs](https://developers.cloudflare.com/r2)

---

*이 문서는 2026-01-03 업데이트 기준으로 작성되었습니다.*
